<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deep Research Engine</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1117; color: #e1e4e8; min-height: 100vh; }

    .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
    h1 { font-size: 24px; font-weight: 600; margin-bottom: 6px; }
    .subtitle { color: #8b949e; font-size: 14px; margin-bottom: 32px; }

    /* Form */
    .form-card { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 28px; margin-bottom: 28px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group.full { grid-column: 1 / -1; }
    label { font-size: 13px; font-weight: 500; color: #8b949e; margin-bottom: 6px; }
    label .req { color: #f85149; }
    input, select, textarea {
      background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
      padding: 10px 12px; color: #e1e4e8; font-size: 14px; font-family: inherit;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #58a6ff; }
    textarea { resize: vertical; min-height: 60px; }
    select { cursor: pointer; }

    .btn {
      background: #238636; color: #fff; border: none; border-radius: 6px;
      padding: 12px 28px; font-size: 15px; font-weight: 600; cursor: pointer;
      transition: background 0.2s; margin-top: 8px;
    }
    .btn:hover { background: #2ea043; }
    .btn:disabled { background: #21262d; color: #484f58; cursor: not-allowed; }

    /* Loading */
    .loading { display: none; align-items: center; gap: 12px; margin-top: 16px; color: #8b949e; font-size: 14px; }
    .loading.active { display: flex; }
    .spinner {
      width: 20px; height: 20px; border: 2px solid #30363d; border-top-color: #58a6ff;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Results */
    .results { display: none; }
    .results.active { display: block; }

    .section { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 24px; margin-bottom: 20px; }
    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .badge {
      font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 12px;
      background: #1f6feb22; color: #58a6ff; border: 1px solid #1f6feb44;
    }
    .badge.yt { background: #f8514922; color: #f85149; border-color: #f8514944; }
    .badge.article { background: #3fb95022; color: #3fb950; border-color: #3fb95044; }

    /* Sources */
    .source-item { padding: 12px; background: #0d1117; border-radius: 6px; margin-bottom: 8px; }
    .source-item a { color: #58a6ff; text-decoration: none; font-weight: 500; }
    .source-item a:hover { text-decoration: underline; }
    .source-meta { font-size: 12px; color: #8b949e; margin-top: 4px; }

    /* Pre-read bullets */
    .bullet-list { list-style: none; }
    .bullet-list li { padding: 8px 0 8px 20px; position: relative; font-size: 14px; line-height: 1.6; border-bottom: 1px solid #21262d; }
    .bullet-list li:last-child { border-bottom: none; }
    .bullet-list li::before { content: '\2022'; position: absolute; left: 0; color: #58a6ff; font-weight: bold; }

    /* Talking points */
    .tp-item { padding: 14px; background: #0d1117; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #58a6ff; }
    .tp-text { font-size: 14px; line-height: 1.5; margin-bottom: 6px; }
    .tp-source { font-size: 12px; color: #8b949e; }
    .tp-source a { color: #58a6ff; text-decoration: none; }

    /* Email */
    .email-block {
      background: #0d1117; border-radius: 6px; padding: 20px; font-size: 14px;
      line-height: 1.7; white-space: pre-wrap; border: 1px solid #30363d;
    }
    .copy-btn {
      background: #21262d; color: #8b949e; border: 1px solid #30363d; border-radius: 6px;
      padding: 6px 14px; font-size: 12px; cursor: pointer; float: right; transition: all 0.2s;
    }
    .copy-btn:hover { color: #e1e4e8; border-color: #58a6ff; }

    /* Metadata */
    .meta-grid { display: flex; gap: 16px; flex-wrap: wrap; }
    .meta-item { font-size: 13px; color: #8b949e; }
    .meta-item span { color: #e1e4e8; font-weight: 500; }

    /* Article log */
    .log-entry { padding: 10px 12px; background: #0d1117; border-radius: 6px; margin-bottom: 6px; font-size: 13px; border-left: 3px solid #30363d; }
    .log-entry.accepted { border-left-color: #3fb950; }
    .log-entry.rejected_no_company_mention { border-left-color: #f85149; }
    .log-entry.fetch_failed { border-left-color: #d29922; }
    .log-entry.skipped_domain { border-left-color: #8b949e; }
    .log-entry.no_results { border-left-color: #8b949e; }
    .log-entry.search_error { border-left-color: #f85149; }
    .log-entry.rejected_too_old { border-left-color: #d29922; }
    .log-query { color: #8b949e; font-size: 11px; margin-bottom: 4px; }
    .log-source { font-size: 10px; font-weight: 600; text-transform: uppercase; padding: 1px 6px; border-radius: 3px; background: #21262d; color: #8b949e; margin-left: 6px; }
    .log-url { color: #58a6ff; word-break: break-all; }
    .log-reason { color: #e1e4e8; margin-top: 3px; }
    .log-status { font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .log-status.accepted { color: #3fb950; }
    .log-status.rejected_no_company_mention { color: #f85149; }
    .log-status.fetch_failed { color: #d29922; }
    .log-status.skipped_domain { color: #8b949e; }
    .log-status.no_results { color: #8b949e; }
    .log-status.search_error { color: #f85149; }
    .log-status.rejected_too_old { color: #d29922; }

    /* Error */
    .error-box { background: #f8514915; border: 1px solid #f8514944; border-radius: 8px; padding: 16px; color: #f85149; font-size: 14px; margin-top: 16px; display: none; }
    .error-box.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Deep Research Engine</h1>
    <p class="subtitle">Sales prep powered by YouTube research + Gemini synthesis</p>

    <!-- Transcription Test -->
    <div class="form-card" style="border-color:#d29922;">
      <div class="section-title" style="color:#d29922;">Transcription Test (temporary)</div>
      <div style="display:flex;gap:10px;align-items:flex-end;">
        <div class="form-group" style="flex:1;">
          <label>YouTube URL</label>
          <input type="text" id="testYtUrl" placeholder="https://www.youtube.com/watch?v=...">
        </div>
        <button class="btn" id="testBtn" onclick="testTranscribe()" style="background:#d29922;height:40px;">Transcribe</button>
      </div>
      <div class="loading" id="testLoading">
        <div class="spinner"></div>
        <div style="flex:1;">
          <span id="testStage">Downloading audio...</span>
          <div style="background:#21262d;border-radius:4px;height:8px;margin-top:6px;overflow:hidden;">
            <div id="testProgressBar" style="background:#d29922;height:100%;width:0%;border-radius:4px;transition:width 0.4s ease;"></div>
          </div>
          <span id="testPercent" style="font-size:12px;color:#8b949e;">0%</span>
        </div>
      </div>
      <div id="testResult" style="display:none;margin-top:14px;">
        <div id="testMeta" style="font-size:13px;color:#8b949e;margin-bottom:8px;"></div>
        <pre id="testText" style="background:#0d1117;border:1px solid #30363d;border-radius:6px;padding:14px;font-size:13px;line-height:1.6;white-space:pre-wrap;max-height:400px;overflow-y:auto;"></pre>
      </div>
      <div class="error-box" id="testError"></div>
    </div>

    <div class="form-card">
      <div class="form-grid">
        <div class="form-group">
          <label>Target Company <span class="req">*</span></label>
          <input type="text" id="target_company" placeholder="e.g. Acme Logistics" required>
        </div>
        <div class="form-group">
          <label>Target Name</label>
          <input type="text" id="target_name" placeholder="e.g. Sarah Chen">
        </div>
        <div class="form-group">
          <label>Target Title</label>
          <input type="text" id="target_title" placeholder="e.g. VP of Revenue Operations">
        </div>
        <div class="form-group">
          <label>Your Role</label>
          <select id="user_role">
            <option value="account_executive">Account Executive</option>
            <option value="sales_dev_rep">SDR</option>
            <option value="customer_success_manager">CSM</option>
            <option value="executive">Executive</option>
          </select>
        </div>
        <div class="form-group">
          <label>Your Name</label>
          <input type="text" id="your_name" placeholder="e.g. Josh">
        </div>
        <div class="form-group">
          <label>Your Company</label>
          <input type="text" id="your_company" placeholder="e.g. Acme Sales Inc.">
        </div>
        <div class="form-group full">
          <label>Context (optional)</label>
          <textarea id="context" placeholder="Deal stage, product interest, anything relevant..."></textarea>
        </div>
      </div>
      <button class="btn" id="runBtn" onclick="runResearch()">Run Research</button>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span id="loadingText">Researching... this may take 30-60 seconds</span>
      </div>
      <div class="error-box" id="errorBox"></div>
    </div>

    <div class="results" id="results">
      <!-- Sources -->
      <div class="section" id="sourcesSection">
        <div class="section-title">Selected Sources</div>
        <div id="sourcesList"></div>
      </div>

      <!-- Pre-Read -->
      <div class="section">
        <div class="section-title">Pre-Read</div>
        <ul class="bullet-list" id="preReadList"></ul>
      </div>

      <!-- Talking Points -->
      <div class="section">
        <div class="section-title">Talking Points</div>
        <div id="talkingPointsList"></div>
      </div>

      <!-- Draft Email -->
      <div class="section">
        <div class="section-title">
          Draft Email
          <button class="copy-btn" onclick="copyEmail()">Copy</button>
        </div>
        <div class="email-block" id="draftEmail"></div>
      </div>

      <!-- Metadata -->
      <div class="section">
        <div class="section-title">Metadata</div>
        <div class="meta-grid" id="metaGrid"></div>
      </div>

      <!-- Article Search Log -->
      <div class="section" id="articleLogSection" style="display:none;">
        <div class="section-title">Article Search Log</div>
        <div id="articleLogList"></div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api/v1/research';

    async function runResearch() {
      const company = document.getElementById('target_company').value.trim();
      if (!company) { alert('Target Company is required'); return; }

      const btn = document.getElementById('runBtn');
      const loading = document.getElementById('loading');
      const errorBox = document.getElementById('errorBox');
      const results = document.getElementById('results');

      btn.disabled = true;
      loading.classList.add('active');
      errorBox.classList.remove('active');
      results.classList.remove('active');

      const body = { target_company: company };
      const optionalFields = ['target_name', 'target_title', 'user_role', 'your_name', 'your_company', 'context'];
      optionalFields.forEach(f => {
        const val = document.getElementById(f).value.trim();
        if (val) body[f] = val;
      });

      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ detail: resp.statusText }));
          throw new Error(err.detail?.error || err.detail || `HTTP ${resp.status}`);
        }

        const data = await resp.json();
        renderResults(data);
        results.classList.add('active');
      } catch (e) {
        errorBox.textContent = 'Error: ' + e.message;
        errorBox.classList.add('active');
      } finally {
        btn.disabled = false;
        loading.classList.remove('active');
      }
    }

    function renderResults(data) {
      // Sources
      const sourcesList = document.getElementById('sourcesList');
      sourcesList.innerHTML = '';
      if (data.selected_sources.length === 0) {
        sourcesList.innerHTML = '<div style="color:#8b949e;font-size:14px;">No sources found</div>';
      }
      data.selected_sources.forEach(s => {
        const badgeClass = s.type === 'youtube' ? 'yt' : 'article';
        const badgeLabel = s.type === 'youtube' ? 'YouTube' : 'Article';
        sourcesList.innerHTML += `
          <div class="source-item">
            <span class="badge ${badgeClass}">${badgeLabel}</span>
            <span class="badge">${s.match_type}</span>
            <a href="${s.url}" target="_blank">${s.title}</a>
            <div class="source-meta">${s.why_selected}</div>
          </div>`;
      });

      // Pre-read
      const preReadList = document.getElementById('preReadList');
      preReadList.innerHTML = '';
      (data.pre_read || []).forEach(b => {
        const li = document.createElement('li');
        li.textContent = b;
        preReadList.appendChild(li);
      });

      // Talking points
      const tpList = document.getElementById('talkingPointsList');
      tpList.innerHTML = '';
      (data.talking_points || []).forEach(tp => {
        const ts = tp.timestamp ? ` (${tp.timestamp})` : '';
        tpList.innerHTML += `
          <div class="tp-item">
            <div class="tp-text">${tp.point}</div>
            <div class="tp-source"><a href="${tp.source_url}" target="_blank">${tp.source_url}</a>${ts}</div>
          </div>`;
      });

      // Email
      document.getElementById('draftEmail').textContent = data.draft_email || 'No email generated';

      // Metadata
      const metaGrid = document.getElementById('metaGrid');
      metaGrid.innerHTML = '';
      if (data.metadata) {
        const m = data.metadata;
        const items = [
          ['Steps', (m.steps_attempted || []).join(' â†’ ')],
          ['Videos', m.total_videos],
          ['Articles', m.total_articles],
          ['With Transcripts', m.videos_with_transcripts],
        ];
        items.forEach(([label, val]) => {
          metaGrid.innerHTML += `<div class="meta-item">${label}: <span>${val}</span></div>`;
        });

        // Article search log
        const logSection = document.getElementById('articleLogSection');
        const logList = document.getElementById('articleLogList');
        const log = m.article_search_log || [];
        if (log.length > 0) {
          logSection.style.display = 'block';
          logList.innerHTML = '';
          log.forEach(entry => {
            const urlHtml = entry.url
              ? `<div class="log-url">${entry.url}</div>`
              : '';
            const sourceHtml = entry.source
              ? `<span class="log-source">${entry.source}</span>`
              : '';
            logList.innerHTML += `
              <div class="log-entry ${entry.status}">
                <div class="log-query">Query: ${entry.query}${sourceHtml}</div>
                ${urlHtml}
                <div class="log-reason">
                  <span class="log-status ${entry.status}">${entry.status.replace(/_/g, ' ')}</span>
                  &mdash; ${entry.reason}
                </div>
              </div>`;
          });
        } else {
          logSection.style.display = 'none';
        }
      }
    }

    function copyEmail() {
      const text = document.getElementById('draftEmail').textContent;
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy', 2000);
      });
    }

    // Allow Enter key on company field to submit
    document.getElementById('target_company').addEventListener('keydown', e => {
      if (e.key === 'Enter') runResearch();
    });

    // --- Transcription test (real-time SSE progress) ---
    function testTranscribe() {
      const url = document.getElementById('testYtUrl').value.trim();
      if (!url) { alert('Enter a YouTube URL'); return; }

      const btn = document.getElementById('testBtn');
      const loading = document.getElementById('testLoading');
      const result = document.getElementById('testResult');
      const errorBox = document.getElementById('testError');
      const bar = document.getElementById('testProgressBar');
      const pct = document.getElementById('testPercent');
      const stage = document.getElementById('testStage');

      btn.disabled = true;
      loading.classList.add('active');
      result.style.display = 'none';
      errorBox.classList.remove('active');
      bar.style.width = '0%';
      pct.textContent = '0%';
      stage.textContent = 'Connecting...';

      const sseUrl = `/api/v1/test-transcribe-stream?youtube_url=${encodeURIComponent(url)}`;
      const evtSource = new EventSource(sseUrl);

      evtSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        // Final result with transcript
        if (data.stage === 'result') {
          evtSource.close();
          document.getElementById('testMeta').textContent =
            `Video: ${data.video_id} | Available: ${data.transcript_available} | ` +
            `Length: ${data.transcript_length.toLocaleString()} chars | Time: ${data.elapsed_seconds}s`;
          document.getElementById('testText').textContent =
            data.transcript || '(no transcript)';
          result.style.display = 'block';
          btn.disabled = false;
          setTimeout(() => loading.classList.remove('active'), 500);
          return;
        }

        // Error
        if (data.stage === 'error') {
          evtSource.close();
          errorBox.textContent = 'Error: ' + (data.detail || 'Unknown error');
          errorBox.classList.add('active');
          btn.disabled = false;
          loading.classList.remove('active');
          return;
        }

        // Progress update
        if (typeof data.percent === 'number' && data.percent >= 0) {
          bar.style.width = data.percent + '%';
          pct.textContent = data.percent + '%';
        }
        if (data.detail) {
          stage.textContent = data.detail;
        }
      };

      evtSource.onerror = function() {
        evtSource.close();
        errorBox.textContent = 'Error: Connection to server lost';
        errorBox.classList.add('active');
        btn.disabled = false;
        loading.classList.remove('active');
      };
    }

    document.getElementById('testYtUrl').addEventListener('keydown', e => {
      if (e.key === 'Enter') testTranscribe();
    });
  </script>
</body>
</html>
