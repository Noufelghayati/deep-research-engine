<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deep Research Engine</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1117; color: #e1e4e8; min-height: 100vh; }

    .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
    h1 { font-size: 24px; font-weight: 600; margin-bottom: 6px; }
    .subtitle { color: #8b949e; font-size: 14px; margin-bottom: 32px; }

    /* Form */
    .form-card { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 28px; margin-bottom: 28px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group.full { grid-column: 1 / -1; }
    label { font-size: 13px; font-weight: 500; color: #8b949e; margin-bottom: 6px; }
    label .req { color: #f85149; }
    input, select, textarea {
      background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
      padding: 10px 12px; color: #e1e4e8; font-size: 14px; font-family: inherit;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #58a6ff; }
    textarea { resize: vertical; min-height: 60px; }
    select { cursor: pointer; }

    .btn {
      background: #238636; color: #fff; border: none; border-radius: 6px;
      padding: 12px 28px; font-size: 15px; font-weight: 600; cursor: pointer;
      transition: background 0.2s; margin-top: 8px;
    }
    .btn:hover { background: #2ea043; }
    .btn:disabled { background: #21262d; color: #484f58; cursor: not-allowed; }

    /* Loading */
    .loading { display: none; align-items: center; gap: 12px; margin-top: 16px; color: #8b949e; font-size: 14px; }
    .loading.active { display: flex; }
    .spinner {
      width: 20px; height: 20px; border: 2px solid #30363d; border-top-color: #58a6ff;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Results */
    .results { display: none; }
    .results.active { display: block; }

    /* Person header */
    .person-header {
      background: #161b22; border: 1px solid #30363d; border-radius: 10px;
      padding: 20px 24px; margin-bottom: 20px; text-align: center;
    }
    .person-name { font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .person-title-co { font-size: 14px; color: #8b949e; margin-top: 4px; }

    /* Signal cards */
    .signals-container { margin-bottom: 20px; }
    .signal-card {
      background: #161b22; border: 1px solid #30363d; border-radius: 8px;
      margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s;
    }
    .signal-card:hover { border-color: #484f58; }
    .signal-card.expanded { border-color: #58a6ff; }

    .signal-header {
      display: flex; align-items: center; padding: 14px 18px; gap: 10px;
    }
    .signal-icon { font-size: 18px; flex-shrink: 0; }
    .signal-text { flex: 1; font-size: 14px; font-weight: 500; line-height: 1.4; }
    .signal-tag {
      font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 4px;
      flex-shrink: 0; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .signal-tag.video { background: #f8514922; color: #f85149; }
    .signal-tag.article { background: #3fb95022; color: #3fb950; }
    .signal-expand {
      font-size: 12px; color: #8b949e; flex-shrink: 0; transition: transform 0.2s;
      width: 20px; text-align: center;
    }
    .signal-card.expanded .signal-expand { transform: rotate(90deg); }

    /* Expanded content */
    .signal-detail {
      display: none; padding: 0 18px 16px 46px;
      border-top: 1px solid #21262d; margin-top: 0;
    }
    .signal-card.expanded .signal-detail { display: block; padding-top: 14px; }

    .signal-quote {
      font-size: 13px; color: #c9d1d9; font-style: italic; line-height: 1.6;
      margin-bottom: 12px; padding-left: 12px; border-left: 3px solid #30363d;
    }
    .signal-quote::before { content: '\201C'; font-size: 18px; color: #484f58; }
    .signal-quote::after { content: '\201D'; font-size: 18px; color: #484f58; }

    .signal-source { font-size: 12px; color: #8b949e; line-height: 1.6; }
    .signal-source a { color: #58a6ff; text-decoration: none; word-break: break-all; }
    .signal-source a:hover { text-decoration: underline; }

    /* Sources footer */
    .sources-footer {
      background: #161b22; border: 1px solid #30363d; border-radius: 8px;
      padding: 14px 18px; font-size: 13px; color: #8b949e; margin-bottom: 20px;
    }

    /* Warning */
    .warning-banner {
      background: #d2992215; border: 1px solid #d2992244; border-radius: 8px;
      padding: 12px 18px; color: #d29922; font-size: 14px; margin-bottom: 16px;
      display: none;
    }
    .warning-banner.active { display: block; }

    /* Error */
    .error-box { background: #f8514915; border: 1px solid #f8514944; border-radius: 8px; padding: 16px; color: #f85149; font-size: 14px; margin-top: 16px; display: none; }
    .error-box.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Deep Research Engine</h1>
    <p class="subtitle">Sales prep powered by YouTube research + Gemini synthesis</p>

    <!-- Transcription Test (hidden) -->
    <div class="form-card" style="border-color:#d29922;display:none;" id="transcriptionTestCard">
      <div style="font-size:16px;font-weight:600;color:#d29922;margin-bottom:12px;">Transcription Test (temporary)</div>
      <div style="display:flex;gap:10px;align-items:flex-end;">
        <div class="form-group" style="flex:1;">
          <label>YouTube URL</label>
          <input type="text" id="testYtUrl" placeholder="https://www.youtube.com/watch?v=...">
        </div>
        <button class="btn" id="testBtn" onclick="testTranscribe()" style="background:#d29922;height:40px;">Transcribe</button>
      </div>
      <div class="loading" id="testLoading">
        <div class="spinner"></div>
        <div style="flex:1;">
          <span id="testStage">Downloading audio...</span>
          <div style="background:#21262d;border-radius:4px;height:8px;margin-top:6px;overflow:hidden;">
            <div id="testProgressBar" style="background:#d29922;height:100%;width:0%;border-radius:4px;transition:width 0.4s ease;"></div>
          </div>
          <span id="testPercent" style="font-size:12px;color:#8b949e;">0%</span>
        </div>
      </div>
      <div id="testResult" style="display:none;margin-top:14px;">
        <div id="testMeta" style="font-size:13px;color:#8b949e;margin-bottom:8px;"></div>
        <pre id="testText" style="background:#0d1117;border:1px solid #30363d;border-radius:6px;padding:14px;font-size:13px;line-height:1.6;white-space:pre-wrap;max-height:400px;overflow-y:auto;"></pre>
      </div>
      <div class="error-box" id="testError"></div>
    </div>

    <div class="form-card">
      <div class="form-grid">
        <div class="form-group">
          <label>Target Company <span class="req">*</span></label>
          <input type="text" id="target_company" placeholder="e.g. Acme Logistics" required>
        </div>
        <div class="form-group">
          <label>Target Name</label>
          <input type="text" id="target_name" placeholder="e.g. Sarah Chen">
        </div>
        <div class="form-group">
          <label>Target Title</label>
          <input type="text" id="target_title" placeholder="e.g. VP of Revenue Operations">
        </div>
        <div class="form-group">
          <label>Your Role</label>
          <select id="user_role">
            <option value="account_executive">Account Executive</option>
            <option value="sales_dev_rep">SDR</option>
            <option value="customer_success_manager">CSM</option>
            <option value="executive">Executive</option>
          </select>
        </div>
        <div class="form-group">
          <label>Your Name</label>
          <input type="text" id="your_name" placeholder="e.g. Josh">
        </div>
        <div class="form-group">
          <label>Your Company</label>
          <input type="text" id="your_company" placeholder="e.g. Acme Sales Inc.">
        </div>
        <div class="form-group full">
          <label>Context (optional)</label>
          <textarea id="context" placeholder="Deal stage, product interest, anything relevant..."></textarea>
        </div>
      </div>
      <button class="btn" id="runBtn" onclick="runResearch()">Run Research</button>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span id="loadingText">Starting research...</span>
      </div>
      <div id="progressLog" style="display:none;margin-top:14px;background:#0d1117;border:1px solid #30363d;border-radius:6px;padding:14px;font-size:13px;line-height:1.8;"></div>
      <div class="error-box" id="errorBox"></div>
    </div>

    <div class="results" id="results">
      <div class="warning-banner" id="warningBanner"></div>
      <div class="person-header" id="personHeader"></div>
      <div class="signals-container" id="signalsContainer"></div>
      <div class="sources-footer" id="sourcesFooter"></div>
    </div>
  </div>

  <script>
    function toggleStepLogs(stepId) {
      const logsDiv = document.getElementById('logs-' + stepId);
      const link = document.getElementById('toggle-' + stepId);
      if (!logsDiv || !link) return;
      if (logsDiv.style.display === 'none') {
        logsDiv.style.display = 'block';
        link.textContent = 'Hide Logs';
      } else {
        logsDiv.style.display = 'none';
        link.textContent = 'Show Logs';
      }
    }

    function runResearch() {
      const company = document.getElementById('target_company').value.trim();
      if (!company) { alert('Target Company is required'); return; }

      const btn = document.getElementById('runBtn');
      const loading = document.getElementById('loading');
      const loadingText = document.getElementById('loadingText');
      const errorBox = document.getElementById('errorBox');
      const results = document.getElementById('results');
      const progressLog = document.getElementById('progressLog');

      btn.disabled = true;
      loading.classList.add('active');
      errorBox.classList.remove('active');
      results.classList.remove('active');
      progressLog.style.display = 'block';
      progressLog.innerHTML = '';
      loadingText.textContent = 'Starting research...';

      const body = { target_company: company };
      const optionalFields = ['target_name', 'target_title', 'user_role', 'your_name', 'your_company', 'context'];
      optionalFields.forEach(f => {
        const val = document.getElementById(f).value.trim();
        if (val) body[f] = val;
      });

      let currentStep = null;

      function ensureStepContainer(stepId) {
        if (document.getElementById('step-' + stepId)) return;
        const container = document.createElement('div');
        container.id = 'step-' + stepId;
        container.style.cssText = 'margin-bottom:6px;';
        container.innerHTML =
          '<div id="header-' + stepId + '"></div>' +
          '<div id="logs-' + stepId + '" style="display:none;margin-left:22px;padding:6px 0 2px 10px;border-left:2px solid #21262d;color:#8b949e;font-size:12px;line-height:1.7;"></div>' +
          '<div id="items-' + stepId + '" style="margin-left:18px;"></div>';
        progressLog.appendChild(container);
      }

      function addLogDetail(stepId, html) {
        const logsDiv = document.getElementById('logs-' + stepId);
        if (!logsDiv) return;
        logsDiv.innerHTML += '<div>' + html + '</div>';
        progressLog.scrollTop = progressLog.scrollHeight;
      }

      function addFoundItem(stepId, html) {
        const itemsDiv = document.getElementById('items-' + stepId);
        if (!itemsDiv) return;
        itemsDiv.innerHTML += '<div>' + html + '</div>';
        progressLog.scrollTop = progressLog.scrollHeight;
      }

      fetch('/api/v1/research-stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function read() {
          reader.read().then(({ done, value }) => {
            if (done) { btn.disabled = false; loading.classList.remove('active'); return; }
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();

            lines.forEach(line => {
              if (!line.startsWith('data: ')) return;
              try {
                const evt = JSON.parse(line.slice(6));

                if (evt.type === 'step') {
                  ensureStepContainer(evt.step);
                  const header = document.getElementById('header-' + evt.step);
                  const toggleHtml = ' <a id="toggle-' + evt.step + '" href="#" onclick="event.preventDefault();toggleStepLogs(\'' + evt.step + '\')" style="color:#58a6ff;font-size:11px;text-decoration:none;margin-left:6px;">Show Logs</a>';
                  if (evt.status === 'searching' || evt.status === 'running') {
                    currentStep = evt.step;
                    loadingText.textContent = evt.message;
                    header.innerHTML = '<span style="color:#8b949e;">&#9679;</span> ' + evt.message + toggleHtml;
                  } else if (evt.status === 'done') {
                    header.innerHTML = '<span style="color:#3fb950;">&#10003;</span> ' + evt.message + toggleHtml;
                  }
                }
                else if (evt.type === 'log') {
                  ensureStepContainer(evt.step);
                  addLogDetail(evt.step, evt.message);
                }
                else if (evt.type === 'found') {
                  const stepId = currentStep || 'step1';
                  const icon = evt.kind === 'video' ? '&#127909;' : '&#128196;';
                  const score = evt.score ? ' <span style="color:#8b949e;">(' + evt.score + ')</span>' : '';
                  addFoundItem(stepId, icon + ' ' + evt.title + score);
                }
                else if (evt.type === 'transcript') {
                  if (evt.status === 'fetching') {
                    const stepId = currentStep || 'step1';
                    addFoundItem(stepId, '<span style="color:#d29922;">&#9997;</span> Transcribing: ' + evt.video);
                  }
                }
                else if (evt.type === 'result') {
                  const doneDiv = document.createElement('div');
                  doneDiv.style.marginTop = '6px';
                  doneDiv.innerHTML = '<span style="color:#3fb950;">&#10003;</span> Done in ' + evt.elapsed + 's';
                  progressLog.appendChild(doneDiv);
                  renderResults(evt.data);
                  results.classList.add('active');
                  btn.disabled = false;
                  loading.classList.remove('active');
                }
                else if (evt.type === 'error') {
                  errorBox.textContent = 'Something went wrong. Please try again.';
                  errorBox.classList.add('active');
                  btn.disabled = false;
                  loading.classList.remove('active');
                }
              } catch(e) {}
            });
            read();
          });
        }
        read();
      }).catch(e => {
        errorBox.textContent = 'Could not connect to the research engine. Please try again.';
        errorBox.classList.add('active');
        btn.disabled = false;
        loading.classList.remove('active');
      });
    }

    function renderResults(data) {
      // Person header
      const personHeader = document.getElementById('personHeader');
      const name = (data.person && data.person.name) || '';
      const title = (data.person && data.person.title) || '';
      const company = (data.person && data.person.company) || '';
      const titleLine = [title, company].filter(Boolean).join(', ');
      if (name) {
        personHeader.innerHTML =
          '<div class="person-name">' + escHtml(name) + '</div>' +
          (titleLine ? '<div class="person-title-co">' + escHtml(titleLine) + '</div>' : '');
        personHeader.style.display = '';
      } else if (company) {
        personHeader.innerHTML =
          '<div class="person-name">' + escHtml(company) + '</div>';
        personHeader.style.display = '';
      } else {
        personHeader.style.display = 'none';
      }

      // Signals
      const container = document.getElementById('signalsContainer');
      container.innerHTML = '';
      const signals = data.signals || [];

      // Warning if < 3 signals
      const warning = document.getElementById('warningBanner');
      if (signals.length > 0 && signals.length < 3) {
        warning.textContent = 'Limited research \u2014 found only ' + signals.length + ' signal' + (signals.length === 1 ? '' : 's') + '.';
        warning.classList.add('active');
      } else if (signals.length === 0) {
        warning.textContent = 'No signals found \u2014 limited public information available for this target.';
        warning.classList.add('active');
      } else {
        warning.classList.remove('active');
      }

      signals.forEach((sig, idx) => {
        const card = document.createElement('div');
        card.className = 'signal-card';
        card.id = 'signal-' + sig.id;

        const sourceType = (sig.source_type || 'VIDEO').toUpperCase();
        const tagClass = sourceType === 'ARTICLE' ? 'article' : 'video';

        const exp = sig.expandable || {};
        const quote = exp.quote || '';
        const src = exp.source || {};
        const srcTitle = src.title || '';
        const srcUrl = src.url || '';
        const srcTs = src.timestamp ? ' \u2022 ' + src.timestamp : '';
        const srcDate = src.date ? ' \u2022 ' + src.date : '';

        card.innerHTML =
          '<div class="signal-header" onclick="toggleSignal(' + sig.id + ')">' +
            '<span class="signal-icon">' + sig.icon + '</span>' +
            '<span class="signal-text">' + escHtml(sig.signal) + '</span>' +
            '<span class="signal-tag ' + tagClass + '">' + sourceType + '</span>' +
            '<span class="signal-expand">&#9654;</span>' +
          '</div>' +
          '<div class="signal-detail">' +
            (quote ? '<div class="signal-quote">' + escHtml(quote) + '</div>' : '') +
            '<div class="signal-source">' +
              (srcTitle ? escHtml(srcTitle) + srcDate + srcTs + '<br>' : '') +
              (srcUrl ? '<a href="' + escAttr(srcUrl) + (src.timestamp ? '&t=' + tsToSec(src.timestamp) : '') + '" target="_blank">' + escHtml(srcUrl) + '</a>' : '') +
            '</div>' +
          '</div>';

        container.appendChild(card);
      });

      // Sources footer
      const footer = document.getElementById('sourcesFooter');
      const sa = data.sources_analyzed || {};
      const vCount = sa.videos || 0;
      const aCount = sa.articles || 0;
      const parts = [];
      if (vCount) parts.push(vCount + ' video' + (vCount !== 1 ? 's' : ''));
      if (aCount) parts.push(aCount + ' article' + (aCount !== 1 ? 's' : ''));
      footer.innerHTML = 'Sources analyzed: ' + (parts.length ? parts.join(', ') : 'none');
    }

    function toggleSignal(signalId) {
      const card = document.getElementById('signal-' + signalId);
      if (!card) return;
      const wasExpanded = card.classList.contains('expanded');
      // Collapse all
      document.querySelectorAll('.signal-card.expanded').forEach(c => c.classList.remove('expanded'));
      // Expand clicked (if it wasn't already open)
      if (!wasExpanded) card.classList.add('expanded');
    }

    function tsToSec(ts) {
      if (!ts) return 0;
      const parts = ts.split(':');
      if (parts.length === 2) return parseInt(parts[0]) * 60 + parseInt(parts[1]);
      return 0;
    }

    function escHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function escAttr(s) {
      return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // Allow Enter key on company field to submit
    document.getElementById('target_company').addEventListener('keydown', e => {
      if (e.key === 'Enter') runResearch();
    });

    // --- Transcription test (real-time SSE progress) ---
    function testTranscribe() {
      const url = document.getElementById('testYtUrl').value.trim();
      if (!url) { alert('Enter a YouTube URL'); return; }

      const btn = document.getElementById('testBtn');
      const loading = document.getElementById('testLoading');
      const result = document.getElementById('testResult');
      const errorBox = document.getElementById('testError');
      const bar = document.getElementById('testProgressBar');
      const pct = document.getElementById('testPercent');
      const stage = document.getElementById('testStage');

      btn.disabled = true;
      loading.classList.add('active');
      result.style.display = 'none';
      errorBox.classList.remove('active');
      bar.style.width = '0%';
      pct.textContent = '0%';
      stage.textContent = 'Connecting...';

      const sseUrl = `/api/v1/test-transcribe-stream?youtube_url=${encodeURIComponent(url)}`;
      const evtSource = new EventSource(sseUrl);

      evtSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.stage === 'result') {
          evtSource.close();
          document.getElementById('testMeta').textContent =
            `Video: ${data.video_id} | Available: ${data.transcript_available} | ` +
            `Length: ${data.transcript_length.toLocaleString()} chars | Time: ${data.elapsed_seconds}s`;
          document.getElementById('testText').textContent =
            data.transcript || '(no transcript)';
          result.style.display = 'block';
          btn.disabled = false;
          setTimeout(() => loading.classList.remove('active'), 500);
          return;
        }

        if (data.stage === 'error') {
          evtSource.close();
          errorBox.textContent = 'Error: ' + (data.detail || 'Unknown error');
          errorBox.classList.add('active');
          btn.disabled = false;
          loading.classList.remove('active');
          return;
        }

        if (typeof data.percent === 'number' && data.percent >= 0) {
          bar.style.width = data.percent + '%';
          pct.textContent = data.percent + '%';
        }
        if (data.detail) {
          stage.textContent = data.detail;
        }
      };

      evtSource.onerror = function() {
        evtSource.close();
        errorBox.textContent = 'Connection lost';
        errorBox.classList.add('active');
        btn.disabled = false;
        loading.classList.remove('active');
      };
    }

    document.getElementById('testYtUrl').addEventListener('keydown', e => {
      if (e.key === 'Enter') testTranscribe();
    });
  </script>
</body>
</html>
