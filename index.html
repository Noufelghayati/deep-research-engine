<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deep Research Engine</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1117; color: #e1e4e8; min-height: 100vh; }

    .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
    h1 { font-size: 24px; font-weight: 600; margin-bottom: 6px; }
    .subtitle { color: #8b949e; font-size: 14px; margin-bottom: 32px; }

    /* Form */
    .form-card { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 28px; margin-bottom: 28px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group.full { grid-column: 1 / -1; }
    label { font-size: 13px; font-weight: 500; color: #8b949e; margin-bottom: 6px; }
    label .req { color: #f85149; }
    input, select, textarea {
      background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
      padding: 10px 12px; color: #e1e4e8; font-size: 14px; font-family: inherit;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #58a6ff; }
    textarea { resize: vertical; min-height: 60px; }
    select { cursor: pointer; }

    .btn {
      background: #238636; color: #fff; border: none; border-radius: 6px;
      padding: 12px 28px; font-size: 15px; font-weight: 600; cursor: pointer;
      transition: background 0.2s; margin-top: 8px;
    }
    .btn:hover { background: #2ea043; }
    .btn:disabled { background: #21262d; color: #484f58; cursor: not-allowed; }

    /* Loading */
    .loading { display: none; align-items: center; gap: 12px; margin-top: 16px; color: #8b949e; font-size: 14px; }
    .loading.active { display: flex; }
    .spinner {
      width: 20px; height: 20px; border: 2px solid #30363d; border-top-color: #58a6ff;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Results */
    .results { display: none; }
    .results.active { display: block; }

    /* Person header */
    .person-header {
      background: #161b22; border: 1px solid #30363d; border-radius: 10px;
      padding: 20px 24px; margin-bottom: 20px; text-align: center;
    }
    .person-name { font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .person-title-co { font-size: 14px; color: #8b949e; margin-top: 4px; }
    .person-prior { font-size: 13px; color: #58a6ff; margin-top: 4px; }

    /* Tabs */
    .view-tabs {
      display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #21262d;
    }
    .view-tab {
      padding: 10px 24px; font-size: 14px; font-weight: 600; cursor: pointer;
      color: #8b949e; border-bottom: 2px solid transparent; margin-bottom: -2px;
      transition: color 0.2s, border-color 0.2s; user-select: none;
    }
    .view-tab:hover { color: #c9d1d9; }
    .view-tab.active { color: #58a6ff; border-bottom-color: #58a6ff; }
    .view-panel { display: none; }
    .view-panel.active { display: block; }

    /* Signal cards */
    .signals-container { margin-bottom: 20px; }
    .signal-card {
      background: #161b22; border: 1px solid #30363d; border-radius: 8px;
      margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s;
    }
    .signal-card:hover { border-color: #484f58; }
    .signal-card.expanded { border-color: #58a6ff; }

    .signal-header {
      display: flex; align-items: center; padding: 14px 18px; gap: 10px;
    }
    .signal-icon { font-size: 18px; flex-shrink: 0; }
    .signal-text { flex: 1; font-size: 14px; font-weight: 500; line-height: 1.4; }
    .signal-tag {
      font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 4px;
      flex-shrink: 0; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .signal-tag.video { background: #f8514922; color: #f85149; }
    .signal-tag.article { background: #3fb95022; color: #3fb950; }
    .signal-expand {
      font-size: 12px; color: #8b949e; flex-shrink: 0; transition: transform 0.2s;
      width: 20px; text-align: center;
    }
    .signal-card.expanded .signal-expand { transform: rotate(90deg); }

    /* Expanded content */
    .signal-detail {
      display: none; padding: 0 18px 16px 46px;
      border-top: 1px solid #21262d; margin-top: 0;
    }
    .signal-card.expanded .signal-detail { display: block; padding-top: 14px; }

    .signal-quote {
      font-size: 13px; color: #c9d1d9; font-style: italic; line-height: 1.6;
      margin-bottom: 12px; padding-left: 12px; border-left: 3px solid #30363d;
    }
    .signal-quote::before { content: '\201C'; font-size: 18px; color: #484f58; }
    .signal-quote::after { content: '\201D'; font-size: 18px; color: #484f58; }

    .signal-source { font-size: 12px; color: #8b949e; line-height: 1.6; }
    .signal-source a { color: #58a6ff; text-decoration: none; word-break: break-all; }
    .signal-source a:hover { text-decoration: underline; }

    /* Sources footer */
    .sources-footer {
      background: #161b22; border: 1px solid #30363d; border-radius: 8px;
      padding: 14px 18px; font-size: 13px; color: #8b949e; margin-bottom: 20px;
    }

    /* Warning */
    .warning-banner {
      background: #d2992215; border: 1px solid #d2992244; border-radius: 8px;
      padding: 12px 18px; color: #d29922; font-size: 14px; margin-bottom: 16px;
      display: none;
    }
    .warning-banner.active { display: block; }

    /* Dossier sections */
    .dossier-section {
      background: #161b22; border: 1px solid #30363d; border-radius: 10px;
      padding: 20px 24px; margin-bottom: 16px;
    }
    .dossier-section-title {
      font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
      color: #8b949e; margin-bottom: 14px; padding-bottom: 8px;
      border-bottom: 1px solid #21262d;
    }
    .dossier-bullet {
      font-size: 14px; line-height: 1.7; color: #c9d1d9;
      padding: 3px 0 3px 16px; position: relative;
    }
    .dossier-bullet::before {
      content: '\2022'; position: absolute; left: 0; color: #484f58;
    }

    /* Strategic focus theme */
    .theme-block { margin-bottom: 16px; }
    .theme-block:last-child { margin-bottom: 0; }
    .theme-title {
      font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
      color: #e1e4e8; margin-bottom: 8px;
    }
    .theme-title .theme-icon { margin-right: 6px; }
    .theme-bullet {
      font-size: 14px; line-height: 1.7; color: #c9d1d9;
      padding: 2px 0 2px 16px; position: relative;
    }
    .theme-bullet::before {
      content: '\2022'; position: absolute; left: 0; color: #484f58;
    }

    /* Quotes */
    .dossier-quote-block { margin-bottom: 14px; }
    .dossier-quote-block:last-child { margin-bottom: 0; }
    .dossier-quote-topic { font-size: 12px; font-weight: 600; color: #8b949e; margin-bottom: 4px; }
    .dossier-quote-text {
      font-size: 14px; color: #c9d1d9; font-style: italic; line-height: 1.6;
      padding-left: 12px; border-left: 3px solid #30363d; margin-bottom: 4px;
    }
    .dossier-quote-text::before { content: '\201C'; font-size: 16px; color: #484f58; }
    .dossier-quote-text::after { content: '\201D'; font-size: 16px; color: #484f58; }
    .dossier-quote-source { font-size: 12px; color: #8b949e; padding-left: 12px; }

    /* Source appendix */
    .source-group-title {
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
      color: #8b949e; margin-top: 12px; margin-bottom: 8px;
    }
    .source-group-title:first-child { margin-top: 0; }
    .source-item {
      font-size: 13px; color: #c9d1d9; line-height: 1.7; padding: 2px 0;
    }
    .source-item a { color: #58a6ff; text-decoration: none; }
    .source-item a:hover { text-decoration: underline; }

    /* Executive Orientation (Quick Prep) */
    .executive-orientation {
      background: #161b22; border: 1px solid #30363d; border-radius: 10px;
      padding: 18px 22px; margin-bottom: 16px;
    }
    .orientation-header {
      font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
      color: #8b949e; margin-bottom: 12px; padding-bottom: 6px;
      border-bottom: 1px solid #21262d;
    }
    .orientation-line {
      font-size: 14px; line-height: 1.7; color: #c9d1d9;
      padding: 2px 0 2px 16px; position: relative;
    }
    .orientation-line::before {
      content: '\2022'; position: absolute; left: 0; color: #484f58;
    }
    .orientation-vulnerable {
      color: #f85149;
    }

    /* Research Confidence badge */
    .confidence-badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600;
      margin-bottom: 16px;
    }
    .confidence-badge.high { background: #23863615; color: #3fb950; border: 1px solid #23863644; }
    .confidence-badge.medium { background: #d2992215; color: #d29922; border: 1px solid #d2992244; }
    .confidence-badge.low { background: #f8514915; color: #f85149; border: 1px solid #f8514944; }

    /* Thin Signal Warning */
    .thin-signal-warning {
      background: #f8514910; border: 1px solid #f8514930; border-radius: 8px;
      padding: 10px 16px; color: #f85149; font-size: 13px; margin-bottom: 16px;
    }

    /* Executive Profile section */
    .leadership-grid {
      display: grid; grid-template-columns: auto 1fr; gap: 4px 12px;
      font-size: 14px; margin-bottom: 14px;
    }
    .leadership-label {
      color: #8b949e; font-weight: 600; font-size: 12px; text-transform: uppercase;
      letter-spacing: 0.5px; padding-top: 2px;
    }
    .leadership-value { color: #c9d1d9; line-height: 1.6; }
    .leadership-implication {
      grid-column: 1 / -1; font-size: 13px; color: #58a6ff;
      font-style: italic; margin-top: 4px; padding-left: 4px;
    }
    .pressure-point { margin-bottom: 12px; }
    .pressure-point:last-child { margin-bottom: 0; }
    .pressure-name {
      font-size: 13px; font-weight: 700; color: #f85149; margin-bottom: 2px;
    }
    .pressure-why {
      font-size: 13px; color: #c9d1d9; line-height: 1.6; margin-bottom: 2px;
    }
    .pressure-evidence {
      font-size: 12px; color: #8b949e; font-style: italic; line-height: 1.5;
    }

    /* Strategic Implication line (under each theme) */
    .theme-implication {
      font-size: 13px; color: #58a6ff; font-style: italic;
      padding: 4px 0 0 16px; margin-bottom: 2px;
    }

    /* Grouped Momentum */
    .momentum-period-title {
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
      color: #58a6ff; margin-top: 12px; margin-bottom: 6px;
    }
    .momentum-period-title:first-child { margin-top: 0; }

    /* Error */
    .error-box { background: #f8514915; border: 1px solid #f8514944; border-radius: 8px; padding: 16px; color: #f85149; font-size: 14px; margin-top: 16px; display: none; }
    .error-box.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Deep Research Engine</h1>
    <p class="subtitle">Executive intelligence powered by multi-source research + Gemini synthesis</p>

    <!-- Transcription Test (hidden) -->
    <div class="form-card" style="border-color:#d29922;display:none;" id="transcriptionTestCard">
      <div style="font-size:16px;font-weight:600;color:#d29922;margin-bottom:12px;">Transcription Test (temporary)</div>
      <div style="display:flex;gap:10px;align-items:flex-end;">
        <div class="form-group" style="flex:1;">
          <label>YouTube URL</label>
          <input type="text" id="testYtUrl" placeholder="https://www.youtube.com/watch?v=...">
        </div>
        <button class="btn" id="testBtn" onclick="testTranscribe()" style="background:#d29922;height:40px;">Transcribe</button>
      </div>
      <div class="loading" id="testLoading">
        <div class="spinner"></div>
        <div style="flex:1;">
          <span id="testStage">Downloading audio...</span>
          <div style="background:#21262d;border-radius:4px;height:8px;margin-top:6px;overflow:hidden;">
            <div id="testProgressBar" style="background:#d29922;height:100%;width:0%;border-radius:4px;transition:width 0.4s ease;"></div>
          </div>
          <span id="testPercent" style="font-size:12px;color:#8b949e;">0%</span>
        </div>
      </div>
      <div id="testResult" style="display:none;margin-top:14px;">
        <div id="testMeta" style="font-size:13px;color:#8b949e;margin-bottom:8px;"></div>
        <pre id="testText" style="background:#0d1117;border:1px solid #30363d;border-radius:6px;padding:14px;font-size:13px;line-height:1.6;white-space:pre-wrap;max-height:400px;overflow-y:auto;"></pre>
      </div>
      <div class="error-box" id="testError"></div>
    </div>

    <div class="form-card">
      <div class="form-grid">
        <div class="form-group">
          <label>Target Company <span class="req">*</span></label>
          <input type="text" id="target_company" placeholder="e.g. Acme Logistics" required>
        </div>
        <div class="form-group">
          <label>Target Name</label>
          <input type="text" id="target_name" placeholder="e.g. Sarah Chen">
        </div>
        <div class="form-group">
          <label>Target Title</label>
          <input type="text" id="target_title" placeholder="e.g. VP of Revenue Operations">
        </div>
        <div class="form-group">
          <label>Your Role</label>
          <select id="user_role">
            <option value="account_executive">Account Executive</option>
            <option value="sales_dev_rep">SDR</option>
            <option value="customer_success_manager">CSM</option>
            <option value="executive">Executive</option>
          </select>
        </div>
        <div class="form-group">
          <label>Your Name</label>
          <input type="text" id="your_name" placeholder="e.g. Josh">
        </div>
        <div class="form-group">
          <label>Your Company</label>
          <input type="text" id="your_company" placeholder="e.g. Acme Sales Inc.">
        </div>
        <div class="form-group full">
          <label>Context (optional)</label>
          <textarea id="context" placeholder="Deal stage, product interest, anything relevant..."></textarea>
        </div>
      </div>
      <button class="btn" id="runBtn" onclick="runResearch()">Run Research</button>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span id="loadingText">Starting research...</span>
      </div>
      <div id="progressLog" style="display:none;margin-top:14px;background:#0d1117;border:1px solid #30363d;border-radius:6px;padding:14px;font-size:13px;line-height:1.8;"></div>
      <div class="error-box" id="errorBox"></div>
    </div>

    <div class="results" id="results">
      <!-- Warnings -->
      <div class="warning-banner" id="warningBanner"></div>

      <!-- Person header -->
      <div class="person-header" id="personHeader"></div>

      <!-- Executive Orientation -->
      <div class="executive-orientation" id="executiveOrientation" style="display:none;"></div>

      <!-- Tabs -->
      <div class="view-tabs">
        <div class="view-tab active" onclick="switchTab('quick')" id="tabQuick">Quick Prep</div>
        <div class="view-tab" onclick="switchTab('dossier')" id="tabDossier">Full Dossier</div>
      </div>

      <!-- VIEW 1: Quick Prep -->
      <div class="view-panel active" id="panelQuick">
        <div class="signals-container" id="signalsContainer"></div>
      </div>

      <!-- VIEW 2: Full Dossier -->
      <div class="view-panel" id="panelDossier">
        <div id="dossierContent"></div>
      </div>

      <!-- Sources footer (shared) -->
      <div class="sources-footer" id="sourcesFooter"></div>
    </div>
  </div>

  <script>
    /* ── Tab switching ── */
    function switchTab(tab) {
      document.getElementById('tabQuick').classList.toggle('active', tab === 'quick');
      document.getElementById('tabDossier').classList.toggle('active', tab === 'dossier');
      document.getElementById('panelQuick').classList.toggle('active', tab === 'quick');
      document.getElementById('panelDossier').classList.toggle('active', tab === 'dossier');
    }

    /* ── Progress log helpers ── */
    function toggleStepLogs(stepId) {
      const logsDiv = document.getElementById('logs-' + stepId);
      const link = document.getElementById('toggle-' + stepId);
      if (!logsDiv || !link) return;
      if (logsDiv.style.display === 'none') {
        logsDiv.style.display = 'block';
        link.textContent = 'Hide Logs';
      } else {
        logsDiv.style.display = 'none';
        link.textContent = 'Show Logs';
      }
    }

    /* ── Main research flow ── */
    function runResearch() {
      const company = document.getElementById('target_company').value.trim();
      if (!company) { alert('Target Company is required'); return; }

      const btn = document.getElementById('runBtn');
      const loading = document.getElementById('loading');
      const loadingText = document.getElementById('loadingText');
      const errorBox = document.getElementById('errorBox');
      const results = document.getElementById('results');
      const progressLog = document.getElementById('progressLog');

      btn.disabled = true;
      loading.classList.add('active');
      errorBox.classList.remove('active');
      results.classList.remove('active');
      progressLog.style.display = 'block';
      progressLog.innerHTML = '';
      loadingText.textContent = 'Starting research...';

      const body = { target_company: company };
      const optionalFields = ['target_name', 'target_title', 'user_role', 'your_name', 'your_company', 'context'];
      optionalFields.forEach(f => {
        const val = document.getElementById(f).value.trim();
        if (val) body[f] = val;
      });

      let currentStep = null;

      function ensureStepContainer(stepId) {
        if (document.getElementById('step-' + stepId)) return;
        const container = document.createElement('div');
        container.id = 'step-' + stepId;
        container.style.cssText = 'margin-bottom:6px;';
        container.innerHTML =
          '<div id="header-' + stepId + '"></div>' +
          '<div id="logs-' + stepId + '" style="display:none;margin-left:22px;padding:6px 0 2px 10px;border-left:2px solid #21262d;color:#8b949e;font-size:12px;line-height:1.7;"></div>' +
          '<div id="items-' + stepId + '" style="margin-left:18px;"></div>';
        progressLog.appendChild(container);
      }

      function addLogDetail(stepId, html) {
        const logsDiv = document.getElementById('logs-' + stepId);
        if (!logsDiv) return;
        logsDiv.innerHTML += '<div>' + html + '</div>';
        progressLog.scrollTop = progressLog.scrollHeight;
      }

      function addFoundItem(stepId, html) {
        const itemsDiv = document.getElementById('items-' + stepId);
        if (!itemsDiv) return;
        itemsDiv.innerHTML += '<div>' + html + '</div>';
        progressLog.scrollTop = progressLog.scrollHeight;
      }

      fetch('/api/v1/research-stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function read() {
          reader.read().then(({ done, value }) => {
            if (done) { btn.disabled = false; loading.classList.remove('active'); return; }
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();

            lines.forEach(line => {
              if (!line.startsWith('data: ')) return;
              try {
                const evt = JSON.parse(line.slice(6));

                if (evt.type === 'step') {
                  ensureStepContainer(evt.step);
                  const header = document.getElementById('header-' + evt.step);
                  const toggleHtml = ' <a id="toggle-' + evt.step + '" href="#" onclick="event.preventDefault();toggleStepLogs(\'' + evt.step + '\')" style="color:#58a6ff;font-size:11px;text-decoration:none;margin-left:6px;">Show Logs</a>';
                  if (evt.status === 'searching' || evt.status === 'running') {
                    currentStep = evt.step;
                    loadingText.textContent = evt.message;
                    header.innerHTML = '<span style="color:#8b949e;">&#9679;</span> ' + evt.message + toggleHtml;
                  } else if (evt.status === 'done') {
                    header.innerHTML = '<span style="color:#3fb950;">&#10003;</span> ' + evt.message + toggleHtml;
                  }
                }
                else if (evt.type === 'log') {
                  ensureStepContainer(evt.step);
                  addLogDetail(evt.step, evt.message);
                }
                else if (evt.type === 'found') {
                  const stepId = currentStep || 'step1';
                  const icon = evt.kind === 'video' ? '&#127909;' : '&#128196;';
                  const score = evt.score ? ' <span style="color:#8b949e;">(' + evt.score + ')</span>' : '';
                  addFoundItem(stepId, icon + ' ' + evt.title + score);
                }
                else if (evt.type === 'transcript') {
                  if (evt.status === 'fetching') {
                    const stepId = currentStep || 'step1';
                    addFoundItem(stepId, '<span style="color:#d29922;">&#9997;</span> Transcribing: ' + evt.video);
                  }
                }
                else if (evt.type === 'result') {
                  const doneDiv = document.createElement('div');
                  doneDiv.style.marginTop = '6px';
                  doneDiv.innerHTML = '<span style="color:#3fb950;">&#10003;</span> Done in ' + evt.elapsed + 's';
                  progressLog.appendChild(doneDiv);
                  renderResults(evt.data);
                  results.classList.add('active');
                  btn.disabled = false;
                  loading.classList.remove('active');
                }
                else if (evt.type === 'error') {
                  errorBox.textContent = 'Something went wrong. Please try again.';
                  errorBox.classList.add('active');
                  btn.disabled = false;
                  loading.classList.remove('active');
                }
              } catch(e) {}
            });
            read();
          });
        }
        read();
      }).catch(e => {
        errorBox.textContent = 'Could not connect to the research engine. Please try again.';
        errorBox.classList.add('active');
        btn.disabled = false;
        loading.classList.remove('active');
      });
    }

    /* ── Render results ── */
    function renderResults(data) {
      // Reset tab to Quick Prep
      switchTab('quick');

      // Person header
      const personHeader = document.getElementById('personHeader');
      const name = (data.person && data.person.name) || '';
      const title = (data.person && data.person.title) || '';
      const company = (data.person && data.person.company) || '';
      const priorRole = (data.person && data.person.prior_role) || '';
      const titleLine = [title, company].filter(Boolean).join(', ');

      let headerHtml = '';
      if (name) {
        headerHtml += '<div class="person-name">' + escHtml(name) + '</div>';
        if (titleLine) headerHtml += '<div class="person-title-co">' + escHtml(titleLine) + '</div>';
        if (priorRole) headerHtml += '<div class="person-prior">Previously: ' + escHtml(priorRole) + '</div>';
      } else if (company) {
        headerHtml += '<div class="person-name">' + escHtml(company) + '</div>';
      }
      personHeader.innerHTML = headerHtml;
      personHeader.style.display = headerHtml ? '' : 'none';

      // Warnings
      const warningBanner = document.getElementById('warningBanner');
      const warnings = data.warnings || [];
      const signals = data.signals || [];
      const allWarnings = [...warnings];
      if (signals.length > 0 && signals.length < 3) {
        allWarnings.push('Limited research \u2014 found only ' + signals.length + ' signal' + (signals.length === 1 ? '' : 's') + '.');
      } else if (signals.length === 0) {
        allWarnings.push('No signals found \u2014 limited public information available for this target.');
      }
      if (allWarnings.length > 0) {
        warningBanner.innerHTML = allWarnings.map(w => '\u26A0\uFE0F ' + escHtml(w)).join('<br>');
        warningBanner.classList.add('active');
      } else {
        warningBanner.classList.remove('active');
      }

      // ── Executive Orientation (between header and signals) ──
      const orientationEl = document.getElementById('executiveOrientation');
      const eo = data.executive_orientation;
      if (eo && (eo.growth_posture || eo.functional_bias || eo.role_context || eo.vulnerable)) {
        let eoHtml = '<div class="orientation-header">\uD83E\uDDED Executive Orientation</div>';
        if (eo.growth_posture) eoHtml += '<div class="orientation-line">' + escHtml(eo.growth_posture) + '</div>';
        if (eo.functional_bias) eoHtml += '<div class="orientation-line">' + escHtml(eo.functional_bias) + '</div>';
        if (eo.role_context) eoHtml += '<div class="orientation-line">' + escHtml(eo.role_context) + '</div>';
        if (eo.vulnerable) eoHtml += '<div class="orientation-line orientation-vulnerable">' + escHtml(eo.vulnerable) + '</div>';
        orientationEl.innerHTML = eoHtml;
        orientationEl.style.display = '';
      } else {
        orientationEl.style.display = 'none';
      }

      // ── VIEW 1: Quick Prep signals ──
      const container = document.getElementById('signalsContainer');
      container.innerHTML = '';

      signals.forEach(function(sig) {
        const card = document.createElement('div');
        card.className = 'signal-card';
        card.id = 'signal-' + sig.id;

        const sourceType = (sig.source_type || 'VIDEO').toUpperCase();
        const tagClass = sourceType === 'ARTICLE' ? 'article' : 'video';

        const exp = sig.expandable || {};
        const quote = exp.quote || '';
        const src = exp.source || {};
        const srcTitle = src.title || '';
        const srcUrl = src.url || '';
        const srcTs = src.timestamp ? ' \u2022 ' + src.timestamp : '';
        const srcDate = src.date ? ' \u2022 ' + src.date : '';

        card.innerHTML =
          '<div class="signal-header" onclick="toggleSignal(' + sig.id + ')">' +
            '<span class="signal-icon">' + sig.icon + '</span>' +
            '<span class="signal-text">' + escHtml(sig.signal) + '</span>' +
            '<span class="signal-tag ' + tagClass + '">' + sourceType + '</span>' +
            '<span class="signal-expand">&#9654;</span>' +
          '</div>' +
          '<div class="signal-detail">' +
            (quote ? '<div class="signal-quote">' + escHtml(quote) + '</div>' : '') +
            '<div class="signal-source">' +
              (srcTitle ? escHtml(srcTitle) + srcDate + srcTs + '<br>' : '') +
              (srcUrl ? '<a href="' + escAttr(srcUrl) + (src.timestamp ? '&t=' + tsToSec(src.timestamp) : '') + '" target="_blank">' + escHtml(srcUrl) + '</a>' : '') +
            '</div>' +
          '</div>';

        container.appendChild(card);
      });

      // ── VIEW 2: Full Dossier ──
      renderDossier(data.dossier || null);

      // Sources footer
      const footer = document.getElementById('sourcesFooter');
      const sa = data.sources_analyzed || {};
      const vCount = sa.videos || 0;
      const aCount = sa.articles || 0;
      const parts = [];
      if (vCount) parts.push(vCount + ' video' + (vCount !== 1 ? 's' : ''));
      if (aCount) parts.push(aCount + ' article' + (aCount !== 1 ? 's' : ''));
      footer.innerHTML = 'Sources analyzed: ' + (parts.length ? parts.join(', ') : 'none');

      // Show/hide dossier tab
      document.getElementById('tabDossier').style.display = data.dossier ? '' : 'none';
    }

    /* ── Render Full Dossier ── */
    function renderDossier(dossier) {
      const el = document.getElementById('dossierContent');
      if (!dossier) {
        el.innerHTML = '<div style="color:#8b949e;font-size:14px;padding:20px;">Dossier not available.</div>';
        return;
      }

      let html = '';

      // Research Confidence badge
      const rc = dossier.research_confidence;
      if (rc && rc.level) {
        const lvl = rc.level.toLowerCase();
        const icons = { high: '\u2705', medium: '\u26A0\uFE0F', low: '\uD83D\uDD34' };
        html += '<div class="confidence-badge ' + lvl + '">' +
          (icons[lvl] || '') + ' Research Confidence: ' + lvl.charAt(0).toUpperCase() + lvl.slice(1) +
          (rc.label ? ' \u2014 ' + escHtml(rc.label) : '') +
          '</div>';
      }

      // Thin Signal Warning
      if (dossier.thin_signal_warning) {
        html += '<div class="thin-signal-warning">\u26A0\uFE0F ' + escHtml(dossier.thin_signal_warning) + '</div>';
      }

      // Section 1: Background
      const bg = (dossier.background && dossier.background.bullets) || [];
      if (bg.length > 0) {
        html += '<div class="dossier-section">';
        html += '<div class="dossier-section-title">Identity &amp; Background</div>';
        bg.forEach(function(b) {
          html += '<div class="dossier-bullet">' + escHtml(b) + '</div>';
        });
        html += '</div>';
      }

      // Section 2: Executive Profile & Strategic Context
      const ep = dossier.executive_profile;
      if (ep) {
        html += '<div class="dossier-section">';
        html += '<div class="dossier-section-title">Executive Profile &amp; Strategic Context</div>';

        // Leadership Orientation
        const lo = ep.leadership_orientation;
        if (lo && (lo.growth_stage || lo.strategic_posture || lo.decision_making_bias)) {
          html += '<div style="font-size:13px;font-weight:700;color:#8b949e;margin-bottom:8px;">\uD83C\uDFAF Leadership Orientation</div>';
          html += '<div class="leadership-grid">';
          if (lo.growth_stage) {
            html += '<div class="leadership-label">Growth Stage</div>';
            html += '<div class="leadership-value">' + escHtml(lo.growth_stage) + '</div>';
          }
          if (lo.strategic_posture) {
            html += '<div class="leadership-label">Strategic Posture</div>';
            html += '<div class="leadership-value">' + escHtml(lo.strategic_posture) + '</div>';
          }
          if (lo.decision_making_bias) {
            html += '<div class="leadership-label">Decision Bias</div>';
            html += '<div class="leadership-value">' + escHtml(lo.decision_making_bias) + '</div>';
          }
          if (lo.strategic_implication) {
            html += '<div class="leadership-implication">\u2192 ' + escHtml(lo.strategic_implication) + '</div>';
          }
          html += '</div>';
        }

        // Pressure Points
        const pp = ep.pressure_points || [];
        if (pp.length > 0) {
          html += '<div style="font-size:13px;font-weight:700;color:#8b949e;margin-top:16px;margin-bottom:8px;">\uD83D\uDEA8 Pressure Points &amp; Vulnerabilities</div>';
          pp.forEach(function(p) {
            html += '<div class="pressure-point">';
            html += '<div class="pressure-name">' + escHtml(p.name || '') + '</div>';
            if (p.why_it_matters) html += '<div class="pressure-why">' + escHtml(p.why_it_matters) + '</div>';
            if (p.evidence) html += '<div class="pressure-evidence">' + escHtml(p.evidence) + '</div>';
            html += '</div>';
          });
        }

        html += '</div>';
      }

      // Section 3: Strategic Focus
      const themes = (dossier.strategic_focus && dossier.strategic_focus.themes) || [];
      if (themes.length > 0) {
        html += '<div class="dossier-section">';
        html += '<div class="dossier-section-title">Current Strategic Focus</div>';
        themes.forEach(function(t) {
          html += '<div class="theme-block">';
          html += '<div class="theme-title"><span class="theme-icon">' + (t.icon || '') + '</span>' + escHtml(t.title || '') + '</div>';
          (t.bullets || []).forEach(function(b) {
            html += '<div class="theme-bullet">' + escHtml(b) + '</div>';
          });
          if (t.strategic_implication) {
            html += '<div class="theme-implication">\u2192 ' + escHtml(t.strategic_implication) + '</div>';
          }
          html += '</div>';
        });
        html += '</div>';
      }

      // Section 4: Quotes
      const quotes = dossier.quotes || [];
      if (quotes.length > 0) {
        html += '<div class="dossier-section">';
        html += '<div class="dossier-section-title">Stated Perspectives &amp; Quotes</div>';
        quotes.forEach(function(q) {
          html += '<div class="dossier-quote-block">';
          html += '<div class="dossier-quote-topic">' + escHtml(q.topic || '') + '</div>';
          html += '<div class="dossier-quote-text">' + escHtml(q.quote || '') + '</div>';
          html += '<div class="dossier-quote-source">' + escHtml(q.source || '') + '</div>';
          html += '</div>';
        });
        html += '</div>';
      }

      // Section 5: Momentum (grouped or flat fallback)
      const momentumGrouped = dossier.momentum_grouped || [];
      const momentumFlat = (dossier.momentum && dossier.momentum.bullets) || [];
      if (momentumGrouped.length > 0) {
        html += '<div class="dossier-section">';
        html += '<div class="dossier-section-title">Recent Company Momentum</div>';
        momentumGrouped.forEach(function(g) {
          if (g.period) html += '<div class="momentum-period-title">' + escHtml(g.period) + '</div>';
          (g.bullets || []).forEach(function(b) {
            html += '<div class="dossier-bullet">' + escHtml(b) + '</div>';
          });
        });
        html += '</div>';
      } else if (momentumFlat.length > 0) {
        html += '<div class="dossier-section">';
        html += '<div class="dossier-section-title">Recent Company Momentum</div>';
        momentumFlat.forEach(function(b) {
          html += '<div class="dossier-bullet">' + escHtml(b) + '</div>';
        });
        html += '</div>';
      }

      // Section 6: Source Appendix
      const sources = dossier.sources || [];
      if (sources.length > 0) {
        const primary = sources.filter(function(s) { return s.type === 'primary'; });
        const supporting = sources.filter(function(s) { return s.type !== 'primary'; });

        html += '<div class="dossier-section">';
        html += '<div class="dossier-section-title">Sources</div>';

        if (primary.length > 0) {
          html += '<div class="source-group-title">\uD83C\uDFAF Primary (Direct Interviews)</div>';
          primary.forEach(function(s) {
            html += '<div class="source-item">' + (s.icon || '') + ' ' + escHtml(s.title || '');
            if (s.platform) html += ' - ' + escHtml(s.platform);
            if (s.date) html += ' - ' + escHtml(s.date);
            if (s.duration) html += ' (' + escHtml(s.duration) + ')';
            if (s.url) html += '<br><a href="' + escAttr(s.url) + '" target="_blank">' + escHtml(s.url) + '</a>';
            html += '</div>';
          });
        }

        if (supporting.length > 0) {
          html += '<div class="source-group-title">\uD83D\uDCC4 Supporting (Company/Press)</div>';
          supporting.forEach(function(s) {
            html += '<div class="source-item">' + (s.icon || '') + ' ' + escHtml(s.title || '');
            if (s.platform) html += ' - ' + escHtml(s.platform);
            if (s.date) html += ' - ' + escHtml(s.date);
            if (s.duration) html += ' (' + escHtml(s.duration) + ')';
            if (s.url) html += '<br><a href="' + escAttr(s.url) + '" target="_blank">' + escHtml(s.url) + '</a>';
            html += '</div>';
          });
        }

        html += '</div>';
      }

      el.innerHTML = html;
    }

    /* ── Signal accordion ── */
    function toggleSignal(signalId) {
      const card = document.getElementById('signal-' + signalId);
      if (!card) return;
      const wasExpanded = card.classList.contains('expanded');
      document.querySelectorAll('.signal-card.expanded').forEach(function(c) { c.classList.remove('expanded'); });
      if (!wasExpanded) card.classList.add('expanded');
    }

    /* ── Helpers ── */
    function tsToSec(ts) {
      if (!ts) return 0;
      var parts = ts.split(':');
      if (parts.length === 2) return parseInt(parts[0]) * 60 + parseInt(parts[1]);
      return 0;
    }

    function escHtml(s) {
      var d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function escAttr(s) {
      return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // Enter key on company field
    document.getElementById('target_company').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') runResearch();
    });

    // --- Transcription test (real-time SSE progress) ---
    function testTranscribe() {
      var url = document.getElementById('testYtUrl').value.trim();
      if (!url) { alert('Enter a YouTube URL'); return; }

      var btn = document.getElementById('testBtn');
      var loading = document.getElementById('testLoading');
      var result = document.getElementById('testResult');
      var errorBox = document.getElementById('testError');
      var bar = document.getElementById('testProgressBar');
      var pct = document.getElementById('testPercent');
      var stage = document.getElementById('testStage');

      btn.disabled = true;
      loading.classList.add('active');
      result.style.display = 'none';
      errorBox.classList.remove('active');
      bar.style.width = '0%';
      pct.textContent = '0%';
      stage.textContent = 'Connecting...';

      var sseUrl = '/api/v1/test-transcribe-stream?youtube_url=' + encodeURIComponent(url);
      var evtSource = new EventSource(sseUrl);

      evtSource.onmessage = function(event) {
        var data = JSON.parse(event.data);

        if (data.stage === 'result') {
          evtSource.close();
          document.getElementById('testMeta').textContent =
            'Video: ' + data.video_id + ' | Available: ' + data.transcript_available + ' | ' +
            'Length: ' + data.transcript_length.toLocaleString() + ' chars | Time: ' + data.elapsed_seconds + 's';
          document.getElementById('testText').textContent =
            data.transcript || '(no transcript)';
          result.style.display = 'block';
          btn.disabled = false;
          setTimeout(function() { loading.classList.remove('active'); }, 500);
          return;
        }

        if (data.stage === 'error') {
          evtSource.close();
          errorBox.textContent = 'Error: ' + (data.detail || 'Unknown error');
          errorBox.classList.add('active');
          btn.disabled = false;
          loading.classList.remove('active');
          return;
        }

        if (typeof data.percent === 'number' && data.percent >= 0) {
          bar.style.width = data.percent + '%';
          pct.textContent = data.percent + '%';
        }
        if (data.detail) {
          stage.textContent = data.detail;
        }
      };

      evtSource.onerror = function() {
        evtSource.close();
        errorBox.textContent = 'Connection lost';
        errorBox.classList.add('active');
        btn.disabled = false;
        loading.classList.remove('active');
      };
    }

    document.getElementById('testYtUrl').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') testTranscribe();
    });
  </script>
</body>
</html>
